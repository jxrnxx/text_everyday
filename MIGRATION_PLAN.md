# Zhanshen â†’ å½“å‰é¡¹ç›® ç§»æ¤æ–¹æ¡ˆ

> åŸºäºå¯¹ `zhanshen` é¡¹ç›®çš„æ·±åº¦åˆ†æï¼Œæ•´ç†å‡ºå€¼å¾—ç§»æ¤çš„æ¡†æ¶å’Œå·¥å…·ç±»ã€‚
> æŒ‰ä¼˜å…ˆçº§æ’åºï¼Œå¯é€æ­¥å®Œæˆç§»æ¤ã€‚

---

## ğŸ“Š é¡¹ç›®å¯¹æ¯”åˆ†æ

| ç»´åº¦ | å½“å‰é¡¹ç›® | Zhanshen | å·®è· |
|------|----------|----------|------|
| **è®¡æ—¶å™¨** | ä½¿ç”¨åŸç”Ÿ `Timers.CreateTimer` | äºŒå‰å †ä¼˜åŒ–çš„é«˜æ€§èƒ½è®¡æ—¶å™¨ | âš ï¸ æ€§èƒ½å·®è· |
| **äº‹ä»¶ç³»ç»Ÿ** | æ— ç‹¬ç«‹äº‹ä»¶ç³»ç»Ÿ | å®Œæ•´çš„å‘å¸ƒ-è®¢é˜…äº‹ä»¶æ€»çº¿ | ğŸ”´ ç¼ºå¤± |
| **ç½‘ç»œè¡¨** | åŸç”Ÿ CustomNetTables (2MBé™åˆ¶) | XNetTable çªç ´é™åˆ¶+åˆ†ç‰‡ä¼ è¾“ | âš ï¸ æ‰©å±•æ€§å·® |
| **å•ä½æ‰©å±•** | æ— æ‰©å±• | å¤§é‡ä¾¿æ·æ–¹æ³• (ä¼ é€ã€è¿åŠ¨å™¨ç­‰) | ğŸ”´ å¼€å‘æ•ˆç‡ä½ |
| **çŠ¶æ€æœº** | æ—  | å®Œæ•´çš„æ¸¸æˆçŠ¶æ€ç®¡ç†å™¨ | ğŸ”´ ç¼ºå¤± |
| **ä¼¤å®³ç³»ç»Ÿ** | ç®€å•çš„ä¼¤å®³è®¡ç®— | å¤šå±‚å¤„ç†é“¾ (æš´å‡»ã€å¸è¡€ã€ç­‰çº§ä¿®æ­£) | âš ï¸ åŠŸèƒ½å•ä¸€ |
| **éšæœºç³»ç»Ÿ** | æ—  | æƒé‡æ±  (æŠ½å¥–ã€æ‰è½) | ğŸ”´ ç¼ºå¤± |
| **åŠ¨ç”»/è¡¥é—´** | æ—  | tween.lua + animations.lua | ğŸ”´ ç¼ºå¤± |

---

## ğŸ¯ ç§»æ¤ä¼˜å…ˆçº§

### âœ… ç¬¬ä¸€ä¼˜å…ˆçº§ï¼šåŸºç¡€å·¥å…· (æ— ä¾èµ–ï¼Œå³æ’å³ç”¨)

è¿™äº›å·¥å…·å®Œå…¨ç‹¬ç«‹ï¼Œå¯ä»¥ç›´æ¥å¤åˆ¶ä½¿ç”¨ã€‚

#### 1. äº‹ä»¶ç³»ç»Ÿ `event.lua`
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/utils/event.lua`
**ç›®æ ‡ä½ç½®**: `game/scripts/src/utils/event.lua`

**åŠŸèƒ½**:
- å‘å¸ƒ-è®¢é˜…æ¨¡å¼çš„äº‹ä»¶æ€»çº¿
- æ”¯æŒäº‹ä»¶ä¼˜å…ˆçº§ (EVENT_LEVEL_LOW/MEDIUM/HIGH/ULTRA)
- æ”¯æŒç»‘å®šå¯¹è±¡å’Œè‡ªåŠ¨è§£æ³¨å†Œ
- ç”¨äºæ¨¡å—é—´è§£è€¦é€šä¿¡

**ä½¿ç”¨ç¤ºä¾‹**:
```lua
-- æ³¨å†Œäº‹ä»¶
local id = Event:on('æ€ªç‰©å‡»æ€', function(killer, victim) 
    print(killer:GetName() .. ' å‡»æ€äº† ' .. victim:GetName())
end)

-- è§¦å‘äº‹ä»¶
Event:send('æ€ªç‰©å‡»æ€', attacker, target)

-- è§£æ³¨å†Œ
Event:unregisterByID(id)
```

**ç§»æ¤éš¾åº¦**: â­ (ç›´æ¥å¤åˆ¶)

---

#### 2. é«˜æ€§èƒ½è®¡æ—¶å™¨ `timers.lua`
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/utils/timers.lua`
**ç›®æ ‡ä½ç½®**: `game/scripts/src/utils/timers.lua`

**åŠŸèƒ½**:
- äºŒå‰å †ä¼˜åŒ–ï¼ŒO(log n) æ’å…¥/åˆ é™¤
- æ”¯æŒæ¸¸æˆæ—¶é—´å’Œå®æ—¶è®¡æ—¶å™¨
- æ”¯æŒæš‚åœæ—¶è‡ªåŠ¨å¤„ç†
- æ¯”åŸç”Ÿè®¡æ—¶å™¨æ›´é«˜æ•ˆ

**ä½¿ç”¨ç¤ºä¾‹**:
```lua
-- å»¶è¿Ÿæ‰§è¡Œ
Timers:CreateTimer(2.0, function()
    print('2ç§’åæ‰§è¡Œ')
end)

-- å¾ªç¯æ‰§è¡Œ
Timers:CreateTimer(1.0, function()
    print('æ¯1ç§’æ‰§è¡Œ')
    return 1.0  -- è¿”å›ä¸‹æ¬¡æ‰§è¡Œé—´éš”
end)
```

**ç§»æ¤éš¾åº¦**: â­ (ç›´æ¥å¤åˆ¶)

---

#### 3. æƒé‡æ±  `pool.lua`
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/utils/pool.lua`
**ç›®æ ‡ä½ç½®**: `game/scripts/src/utils/pool.lua`

**åŠŸèƒ½**:
- æƒé‡éšæœºæŠ½å–
- æ”¯æŒæŠ½å–åç§»é™¤/ä¸ç§»é™¤
- æ”¯æŒåŠ¨æ€å¢å‡æƒé‡
- é€‚ç”¨äºæ‰è½è¡¨ã€æŠ½å¥–ã€éšæœºäº‹ä»¶

**ä½¿ç”¨ç¤ºä¾‹**:
```lua
local pool = Pool:new()
pool:add('æ™®é€šè£…å¤‡', 70)  -- 70% æ¦‚ç‡
pool:add('ç¨€æœ‰è£…å¤‡', 25)  -- 25% æ¦‚ç‡
pool:add('ä¼ è¯´è£…å¤‡', 5)   -- 5% æ¦‚ç‡

local item = pool:draw()  -- æŒ‰æƒé‡éšæœºæŠ½å–
```

**ç§»æ¤éš¾åº¦**: â­ (ç›´æ¥å¤åˆ¶)

---

#### 4. è¡¥é—´åŠ¨ç”» `tween.lua`
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/utils/tween.lua`
**ç›®æ ‡ä½ç½®**: `game/scripts/src/utils/tween.lua`

**åŠŸèƒ½**:
- æ•°å€¼/ä½ç½®å¹³æ»‘è¿‡æ¸¡
- å¤šç§ç¼“åŠ¨å‡½æ•° (linear, outQuad, inOutQuadç­‰)
- é€‚ç”¨äºUIåŠ¨ç”»ã€å•ä½ç§»åŠ¨ã€ç‰¹æ•ˆ

**ç§»æ¤éš¾åº¦**: â­ (ç›´æ¥å¤åˆ¶)

---

### âš¡ ç¬¬äºŒä¼˜å…ˆçº§ï¼šæ ¸å¿ƒæ¡†æ¶ (éœ€å°‘é‡é€‚é…)

#### 5. XNetTable çªç ´ç½‘è¡¨é™åˆ¶
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/modules/xnet-table.ts`
**ç›®æ ‡ä½ç½®**: `game/scripts/src/modules/xnet-table.ts`

**åŠŸèƒ½**:
- çªç ´åŸç”Ÿ CustomNetTables 2MB é™åˆ¶
- æ”¯æŒæ•°æ®åˆ†ç‰‡ä¼ è¾“ (MTUæœºåˆ¶)
- æ”¯æŒç©å®¶ç§æœ‰æ•°æ®
- è‡ªåŠ¨å¤„ç†ç©å®¶é‡è¿åŒæ­¥

**é€‚é…å·¥ä½œ**:
- éœ€è¦åˆ›å»ºå¯¹åº”çš„ç±»å‹å®šä¹‰ `xnet-table.d.ts`
- éœ€è¦åœ¨å‰ç«¯æ·»åŠ æ¥æ”¶é€»è¾‘

**ç§»æ¤éš¾åº¦**: â­â­ (éœ€è¦é€‚é…ç±»å‹å’Œå‰ç«¯)

---

#### 6. çŠ¶æ€ç®¡ç†å™¨ StateManager
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/my_game/state_manager/`
**ç›®æ ‡ä½ç½®**: `game/scripts/src/systems/state_manager/`

**åŠŸèƒ½**:
- æ¸¸æˆçŠ¶æ€æœº (Loading â†’ MainMenu â†’ Playing â†’ Defeated)
- å¿ƒè·³äº‹ä»¶é©±åŠ¨
- çŠ¶æ€åˆ‡æ¢æ—¶è‡ªåŠ¨è°ƒç”¨ OnStart/OnEnd
- æ”¯æŒæš‚åœ/æ¢å¤

**éœ€è¦ç§»æ¤çš„æ–‡ä»¶**:
- `state_manager.ts` - æ ¸å¿ƒçŠ¶æ€ç®¡ç†å™¨
- `base_state.ts` - çŠ¶æ€åŸºç±» (å·²åŒ…å«åœ¨state_manager.tsä¸­)
- æŒ‰éœ€åˆ›å»ºè‡ªå·±çš„çŠ¶æ€ç±»

**ç§»æ¤éš¾åº¦**: â­â­ (éœ€è¦æ ¹æ®æ¸¸æˆæµç¨‹é€‚é…çŠ¶æ€)

---

### ğŸ’ª ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼šå¢å¼ºæ¡†æ¶ (é€‰æ‹©æ€§ç§»æ¤)

#### 7. CDOTA_BaseNPC æ‰©å±•æ–¹æ³•
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/enhance/CDOTA_BaseNPC.ts`
**ç›®æ ‡ä½ç½®**: `game/scripts/src/enhance/CDOTA_BaseNPC.ts`

**æ¨èç§»æ¤çš„æ–¹æ³•**:

| æ–¹æ³• | ç”¨é€” | æ¨èåº¦ |
|------|------|--------|
| `Teleport(point)` | ä¼ é€å•ä½(å¸¦ç‰¹æ•ˆ) | â­â­â­ |
| `Mover(target, time)` | ä½ç§»è¿åŠ¨å™¨ | â­â­â­ |
| `Bezier2Mover/Bezier3Mover` | è´å¡å°”æ›²çº¿è¿åŠ¨ | â­â­ |
| `LockTarget(target)` | æœå‘é”å®š | â­â­â­ |
| `RoundAOE(radius, callback)` | åœ†å½¢èŒƒå›´é€‰å– | â­â­â­ |
| `GetMinDistanceUnit()` | æœ€è¿‘å•ä½é€‰å– | â­â­â­ |
| `CustomValue` ç³»åˆ— | è‡ªå®šä¹‰å±æ€§å­˜å‚¨ | â­â­â­ |
| `RecoverBlood/SacrificeBlood` | å›è¡€/ç‰ºç‰² | â­â­ |
| `AddMaxBaseHealth/AddBaseDamage` | å±æ€§å¢åŠ  | â­â­â­ |
| `CreateNumber` | æµ®åŠ¨æ•°å­— | â­â­ |
| `SafetyRemoveSelf` | å®‰å…¨ç§»é™¤å•ä½ | â­â­â­ |

**ç§»æ¤éš¾åº¦**: â­â­â­ (éœ€è¦æ ¹æ®éœ€æ±‚é€‰æ‹©æ€§ç§»æ¤)

---

#### 8. å…¨å±€å·¥å…·å‡½æ•°
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/enhance/global.ts`
**ç›®æ ‡ä½ç½®**: `game/scripts/src/utils/global.ts`

**æ¨èç§»æ¤çš„å‡½æ•°**:

| å‡½æ•° | ç”¨é€” | æ¨èåº¦ |
|------|------|--------|
| `RotateVector2D(v, angle)` | 2Då‘é‡æ—‹è½¬ | â­â­â­ |
| `GetRotateVectors(forward, angle, count)` | ç”Ÿæˆæ‰‡å½¢å‘é‡ç»„ | â­â­â­ |
| `CustomApplyDamage(data)` | è‡ªå®šä¹‰ä¼¤å®³ç³»ç»Ÿ | â­â­â­ |
| `deepClone(obj)` | æ·±æ‹·è´ | â­â­â­ |
| `FindNearestWalkablePoint` | å¯»æ‰¾å¯è¡Œèµ°ç‚¹ | â­â­ |
| `DiceRoll()` | æ·éª°å­/æ¦‚ç‡åˆ¤å®š | â­â­ |

**ç§»æ¤éš¾åº¦**: â­â­ (é€‰æ‹©éœ€è¦çš„å‡½æ•°ç§»æ¤)

---

### ğŸš€ ç¬¬å››ä¼˜å…ˆçº§ï¼šé«˜çº§ç³»ç»Ÿ (å‚è€ƒè®¾è®¡)

è¿™äº›ç³»ç»Ÿæ¯”è¾ƒå¤æ‚ï¼Œå»ºè®®å…ˆå‚è€ƒè®¾è®¡æ€æƒ³ï¼ŒæŒ‰éœ€é‡æ–°å®ç°ã€‚

#### 9. ä¼¤å®³ç³»ç»Ÿ DamageComp
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/my_game/damage_comp.ts`

**è®¾è®¡äº®ç‚¹**:
- å¤šå±‚ä¼¤å®³å¤„ç†é“¾
- å‰ç½®é™„åŠ  â†’ é¢„å¤„ç† â†’ ä¼¤å®³ç»“ç®— â†’ æ˜¾ç¤º
- æš´å‡»ã€å¸è¡€ã€ç­‰çº§ä¿®æ­£ã€ä¸­æ¯’ç­‰ç‹¬ç«‹å¤„ç†
- ä¼¤å®³æ•°å­—æ˜¾ç¤ºç³»ç»Ÿ

**å»ºè®®**: å‚è€ƒå…¶æ¶æ„ï¼Œé‡æ„å½“å‰é¡¹ç›®çš„ä¼¤å®³è®¡ç®—

---

#### 10. ç©å®¶ç³»ç»Ÿ Player
**æºæ–‡ä»¶**: `zhanshen/game/scripts/src/my_game/player.ts`

**è®¾è®¡äº®ç‚¹**:
- å®Œæ•´çš„ç©å®¶å®ä½“å°è£…
- èµ„äº§ç®¡ç† (AddAsset/SubAsset/CostAsset)
- å¤æ´»/å¢“ç¢‘/å›åŸæœºåˆ¶
- ç»éªŒ/ç­‰çº§/æˆ˜åŠ›ç³»ç»Ÿ

**å»ºè®®**: å‚è€ƒå…¶èµ„äº§å’Œå¤æ´»è®¾è®¡

---

## ğŸ“ ç§»æ¤åçš„é¡¹ç›®ç»“æ„

```
game/scripts/src/
â”œâ”€â”€ utils/                    # å·¥å…·ç±» (ç¬¬ä¸€ä¼˜å…ˆçº§)
â”‚   â”œâ”€â”€ event.lua            # [æ–°å¢] äº‹ä»¶ç³»ç»Ÿ
â”‚   â”œâ”€â”€ event.d.ts           # [æ–°å¢] ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ timers.lua           # [æ–°å¢] é«˜æ€§èƒ½è®¡æ—¶å™¨
â”‚   â”œâ”€â”€ timers.d.ts          # [æ–°å¢] ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ pool.lua             # [æ–°å¢] æƒé‡æ± 
â”‚   â”œâ”€â”€ pool.d.ts            # [æ–°å¢] ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ tween.lua            # [æ–°å¢] è¡¥é—´åŠ¨ç”»
â”‚   â”œâ”€â”€ tween.d.ts           # [æ–°å¢] ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ global.ts            # [æ–°å¢] å…¨å±€å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ modules/                  # æ ¸å¿ƒæ¨¡å— (ç¬¬äºŒä¼˜å…ˆçº§)
â”‚   â””â”€â”€ xnet-table.ts        # [æ–°å¢] çªç ´æ€§ç½‘è¡¨
â”‚
â”œâ”€â”€ enhance/                  # åŸç”Ÿç±»å¢å¼º (ç¬¬ä¸‰ä¼˜å…ˆçº§)
â”‚   â””â”€â”€ CDOTA_BaseNPC.ts     # [æ–°å¢] å•ä½æ‰©å±•æ–¹æ³•
â”‚
â”œâ”€â”€ systems/                  # æ¸¸æˆç³»ç»Ÿ
â”‚   â”œâ”€â”€ state_manager/       # [æ–°å¢] çŠ¶æ€ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ state_manager.ts
â”‚   â”‚   â”œâ”€â”€ loading_state.ts
â”‚   â”‚   â”œâ”€â”€ playing_state.ts
â”‚   â”‚   â””â”€â”€ defeated_state.ts
â”‚   â”œâ”€â”€ WaveManager.ts
â”‚   â”œâ”€â”€ CustomStats.ts
â”‚   â”œâ”€â”€ RankSystem.ts
â”‚   â””â”€â”€ UpgradeSystem.ts
â”‚
â””â”€â”€ GameMode.ts
```

---

## âœ… ç§»æ¤æ£€æŸ¥æ¸…å•

### ç¬¬ä¸€é˜¶æ®µï¼šåŸºç¡€å·¥å…· âœ… å·²å®Œæˆ
- [x] ç§»æ¤ `event.lua` + åˆ›å»º `event.d.ts` âœ… (2026-01-18)
- [x] ~~ç§»æ¤ `timers.lua`~~ **è·³è¿‡** (åŸé¡¹ç›®å·²æœ‰ Timers ç³»ç»Ÿ)
- [x] ç§»æ¤ `pool.lua` + åˆ›å»º `pool.d.ts` âœ… (2026-01-18)
- [x] ç§»æ¤ `tween.lua` â†’ `tween_lib.lua` + åˆ›å»º `tween.d.ts` âœ… (2026-01-18)
  - æ³¨ï¼šé‡å‘½åä¸º `tween_lib.lua` é¿å…ä¸ç°æœ‰ `tween.ts` å†²çª
- [x] æµ‹è¯•æ‰€æœ‰å·¥å…·ç±»æ­£å¸¸å·¥ä½œ âœ… (2026-01-18)

### ç¬¬äºŒé˜¶æ®µï¼šæ ¸å¿ƒæ¡†æ¶ âœ… å·²å®Œæˆ
- [x] ~~ç§»æ¤ `xnet-table.ts`~~ **è·³è¿‡** (é¡¹ç›®å·²æœ‰å®Œæ•´ç‰ˆæœ¬ MTU 64KB)
- [x] ç§»æ¤çŠ¶æ€ç®¡ç†å™¨æ¡†æ¶ âœ… (2026-01-18)
- [x] åˆ›å»ºæ¸¸æˆçŠ¶æ€ç±» (Loading/Playing/Victory/Defeat) âœ… (2026-01-18)
- [x] é›†æˆçŠ¶æ€ç®¡ç†å™¨åˆ° GameMode âœ… (2026-01-18)

### ç¬¬ä¸‰é˜¶æ®µï¼šå¢å¼ºæ¡†æ¶
- [x] é€‰æ‹©æ€§ç§»æ¤ CDOTA_BaseNPC æ‰©å±•æ–¹æ³• âœ… (2026-01-18)
  - GetCustomValue/SetCustomValue, Mover, GetMinDistanceUnit
  - Pause, SafetyRemoveSelf, RecoverBlood, RoundAOE
- [x] ç§»æ¤å…¨å±€å·¥å…·å‡½æ•° âœ… (2026-01-18)
  - AngleToVector, RotateVector2D, GetRotateVectors
  - Bezier2, Bezier3, deepClone, IsValid, CreateParticleToPoint
- [x] é‡æ„ CustomStats ä½¿ç”¨ CustomValue âœ… (2026-01-18)
  - æ•°æ®å­˜å‚¨ä» cache è¿ç§»åˆ° unit.CustomValue
  - æ·»åŠ  SyncToNetTable æ–¹æ³•åŒæ­¥åˆ°å®¢æˆ·ç«¯
  - modifier_custom_stats_handler å®Œå…¨å…¼å®¹

### ç¬¬å››é˜¶æ®µï¼šç³»ç»Ÿä¼˜åŒ–
- [ ] å‚è€ƒ DamageComp é‡æ„ä¼¤å®³ç³»ç»Ÿ
- [ ] å‚è€ƒ Player ä¼˜åŒ–ç©å®¶ç®¡ç†
- [ ] æ ¹æ®éœ€è¦ç§»æ¤å…¶ä»–ç³»ç»Ÿ

---

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **ç±»å‹å®šä¹‰**: Lua å·¥å…·ç±»éœ€è¦åˆ›å»ºå¯¹åº”çš„ `.d.ts` ç±»å‹å®šä¹‰æ–‡ä»¶
2. **å‘½åç©ºé—´**: ç¡®ä¿å…¨å±€å˜é‡ä¸å†²çª (Event, Timers, Pool ç­‰)
3. **ä¾èµ–é¡ºåº**: æŸäº›æ¨¡å—ä¾èµ– Event ç³»ç»Ÿï¼Œéœ€è¦å…ˆç§»æ¤ Event
4. **æµ‹è¯•éªŒè¯**: æ¯æ¬¡ç§»æ¤åéƒ½è¦åœ¨æ¸¸æˆä¸­æµ‹è¯•åŠŸèƒ½æ­£å¸¸
5. **æ¸è¿›å¼**: ä¸è¦ä¸€æ¬¡ç§»æ¤å¤ªå¤šï¼Œé€æ­¥é›†æˆå’Œæµ‹è¯•

---

## ğŸ”— ç›¸å…³æ–‡ä»¶è·¯å¾„

| ç±»å‹ | æºé¡¹ç›®è·¯å¾„ |
|------|-----------|
| å·¥å…·ç±» | `d:\text_everyday\zhanshen\game\scripts\src\utils\` |
| å¢å¼ºæ¡†æ¶ | `d:\text_everyday\zhanshen\game\scripts\src\enhance\` |
| çŠ¶æ€ç®¡ç† | `d:\text_everyday\zhanshen\game\scripts\src\my_game\state_manager\` |
| ç©å®¶ç³»ç»Ÿ | `d:\text_everyday\zhanshen\game\scripts\src\my_game\player.ts` |
| ä¼¤å®³ç³»ç»Ÿ | `d:\text_everyday\zhanshen\game\scripts\src\my_game\damage_comp.ts` |
| ç½‘ç»œæ¨¡å— | `d:\text_everyday\zhanshen\game\scripts\src\modules\xnet-table.ts` |

---

*æœ€åæ›´æ–°: 2026-01-18*
*åŸºäº zhanshen é¡¹ç›®æ·±åº¦åˆ†æ*
